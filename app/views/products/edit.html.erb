<div class="row justify-content-center">
  <div class="col-lg-8 col-md-10">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">
          <i class="fas fa-edit me-2"></i>
          Edit Product
        </h3>
      </div>
      <div class="card-body">
        <%= form_with(model: @product, local: true, html: { multipart: true, class: "needs-validation", novalidate: true }) do |form| %>
          <% if @product.errors.any? %>
            <div class="alert alert-danger" role="alert">
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Please fix the following errors:</h5>
              <ul class="mb-0">
                <% @product.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :title, class: "form-label fw-semibold" %>
              <%= form.text_field :title, class: "form-control #{'is-invalid' if @product.errors[:title].any?}", placeholder: "Enter product title", required: true %>
              <% if @product.errors[:title].any? %>
                <div class="invalid-feedback">
                  <%= @product.errors[:title].first %>
                </div>
              <% end %>
            </div>
            <div class="col-md-6 mb-3">
              <%= form.label :category, class: "form-label fw-semibold" %>
              <%= form.collection_select :category_id, Category.all, :id, :name,
                            { prompt: 'Select a category' },
                            { class: "form-select #{'is-invalid' if @product.errors[:category_id].any?}", required: true } %>
              <% if @product.errors[:category].any? %>
                <div class="invalid-feedback">
                  <%= @product.errors[:category].first %>
                </div>
              <% end %>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :price, class: "form-label fw-semibold" %>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <%= form.number_field :price, step: 0.01, min: 0, class: "form-control #{'is-invalid' if @product.errors[:price].any?}", placeholder: "0.00", required: true %>
                <% if @product.errors[:price].any? %>
                  <div class="invalid-feedback">
                    <%= @product.errors[:price].first %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <%= form.label :description, class: "form-label fw-semibold" %>
            <%= form.text_area :description, rows: 4, class: "form-control #{'is-invalid' if @product.errors[:description].any?}", placeholder: "Describe your product in detail..." %>
            <div class="form-text">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Provide a detailed description to help buyers understand your product better.
              </small>
            </div>
            <% if @product.errors[:description].any? %>
              <div class="invalid-feedback">
                <%= @product.errors[:description].first %>
              </div>
            <% end %>
          </div>
          <div class="mb-3">
            <%= form.label :preview_image, "Product Image", class: "form-label fw-semibold" %>
            <% if @product.preview_image.attached? %>
              <div class="mb-2">
                <%= image_tag @product.preview_image.variant(resize_to_limit: [300, 300]), class: "img-thumbnail" %>
                <div class="form-check mt-2">
                  <%= form.check_box :remove_preview_image, class: "form-check-input" %>
                  <%= form.label :remove_preview_image, "Remove current image", class: "form-check-label" %>
                </div>
              </div>
            <% end %>
            <%= form.file_field :preview_image, class: "form-control #{'is-invalid' if @product.errors[:preview_image].any?}", accept: "image/*" %>
            <div class="form-text">
              <small class="text-muted">
              <i class="fas fa-camera me-1"></i>
                            Upload a high-quality image of your product (JPG, PNG, or GIF format).
              </small>
            </div>
            <% if @product.errors[:preview_image].any? %>
              <div class="invalid-feedback">
                <%= @product.errors[:preview_image].first %>
              </div>
            <% end %>
          </div>
          <div class="mb-3">
            <%= form.label :downloadable_asset, "Product File", class: "form-label fw-semibold" %>
            <% if @product.downloadable_asset.attached? %>
              <div class="mb-2">
                <%= link_to @product.downloadable_asset.filename,
                                        rails_blob_path(@product.downloadable_asset, disposition: 'attachment'),
                                        class: "btn btn-sm btn-outline-primary" %>
                <div class="form-check mt-2">
                  <%= form.check_box :remove_downloadable_asset, class: "form-check-input" %>
                  <%= form.label :remove_downloadable_asset, "Remove current file", class: "form-check-label" %>
                </div>
              </div>
            <% end %>
            <%= form.file_field :downloadable_asset, class: "form-control #{'is-invalid' if @product.errors[:downloadable_asset].any?}" %>
          </div>
          <hr class="my-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <%= link_to product_path(@product), class: "btn btn-secondary" do %>
                <i class="fas fa-arrow-left me-2"></i>
                Back to Product
              <% end %>
            </div>
            <div class="d-flex gap-2">
              <%= form.button type: "submit", name: "draft", class: "btn btn-outline-primary" do %>
                <i class="fas fa-save me-2"></i>
                Save as Draft
              <% end %>
              <%= form.submit "Update Product", class: "btn btn-primary" do %>
                <i class="fas fa-save me-2"></i>
                Update Product
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <!-- Preview Section -->
    <div class="card shadow-sm mt-4" id="product-preview">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-eye me-2"></i>
            Product Preview
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <% if @product.preview_image.attached? %>
              <%= image_tag @product.preview_image.variant(resize_to_limit: [300, 300]), class: "img-fluid rounded" %>
            <% else %>
              <div class="preview-image-placeholder bg-light border rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-image fa-3x text-muted"></i>
              </div>
            <% end %>
          </div>
          <div class="col-md-8">
            <h4><%= @product.title %></h4>
            <p><span class="badge bg-secondary"><%= @product.category&.name || 'No category' %></span></p>
            <h3 class="text-primary">$<%= @product.price %></h3>
            <p><%= @product.description %></p>
            <div class="preview-details">
              <small class="text-muted">
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  .card {
    border: none;
    border-radius: 12px;
  }
  .card-header {
    border-radius: 12px 12px 0 0 !important;
    border-bottom: 1px solid #dee2e6;
  }
  .form-control:focus,
  .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
  .btn {
    border-radius: 8px;
    font-weight: 500;
  }
  .form-label {
    color: #495057;
    margin-bottom: 0.5rem;
  }
  .preview-image-placeholder {
    border: 2px dashed #dee2e6 !important;
  }
</style>
<script>
  // Form validation and preview updates
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.needs-validation');
    const previewSection = document.getElementById('product-preview');
    // Form submission validation
    form?.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
    // Real-time preview updates for editable fields
    const updatePreview = () => {
      const nameInput = document.getElementById('product_title');
      const categorySelect = document.getElementById('product_category_id');
      const priceInput = document.getElementById('product_price');
      const descriptionInput = document.getElementById('product_description');
      if (nameInput) {
        document.querySelector('#product-preview h4').textContent = nameInput.value;
      }
      if (categorySelect) {
        const categoryName = categorySelect.options[categorySelect.selectedIndex]?.text || 'No category';
        document.querySelector('#product-preview .badge').textContent = categoryName;
      }
      if (priceInput) {
        document.querySelector('#product-preview .text-primary').textContent = '$' + priceInput.value;
      }
      if (descriptionInput) {
        document.querySelector('#product-preview p:nth-of-type(2)').textContent = descriptionInput.value;
      }
    };
    // Add event listeners for preview updates
    ['input', 'change'].forEach(eventType => {
      document.querySelectorAll('#product_title, #product_category_id, #product_price, #product_description').forEach(input => {
        input.addEventListener(eventType, updatePreview);
      });
    });
  });
</script>