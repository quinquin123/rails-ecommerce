<!-- app/views/reviews/_reviews.html.erb -->
<div class="reviews-section">
  <div class="reviews-header d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">
      Customer Reviews 
      <span class="text-muted fs-6">(<%= product.reviews_count %> reviews)</span>
    </h4>
    
    <% if product.reviews_count > 0 %>
      <div class="overall-rating">
        <div class="rating-display">
          <span class="average-rating fs-5 fw-bold text-warning">
            <%= product.average_rating %>
          </span>
          <div class="stars">
            <% product.average_rating.to_i.times do %>
              <i class="fas fa-star text-warning"></i>
            <% end %>
            <% (5 - product.average_rating.to_i).times do %>
              <i class="far fa-star text-warning"></i>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Add Review Button -->
  <% if user_signed_in? && current_user.buyer? %>
    <% user_has_reviewed = product.reviews.exists?(buyer: current_user) %>
    <% user_has_purchased = current_user.orders.joins(:order_items)
                                      .where(order_items: { product: product })
                                      .where(status: 'delivered').exists? %>
    
    <% unless user_has_reviewed %>
      <% if user_has_purchased %>
        <div class="mb-4">
          <button type="button" class="btn btn-outline-primary" onclick="toggleReviewForm()">
            <i class="fas fa-plus"></i> Write a Review
          </button>
        </div>
        
        <div id="review-form-container" style="display: none;">
          <%= render 'reviews/form', review: Review.new, product: product, order: nil %>
        </div>
      <% else %>
        <div class="alert alert-info mb-4">
          <i class="fas fa-info-circle"></i>
          You need to purchase and receive this product before you can write a review.
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-success mb-4">
        <i class="fas fa-check-circle"></i>
        You have already reviewed this product.
      </div>
    <% end %>
  <% end %>

  <!-- Reviews List -->
  <div class="reviews-list">
    <% if product.reviews.any? %>
      <% product.reviews.includes(:buyer).order(created_at: :desc).each do |review| %>
        <div class="review-item border-bottom py-4">
          <div class="review-header d-flex justify-content-between align-items-start mb-3">
            <div class="reviewer-info">
              <div class="d-flex align-items-center mb-2">
                <div class="reviewer-avatar me-2">
                  <i class="fas fa-user-circle text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-0 fw-semibold">
                    <%= review.buyer.name.present? ? review.buyer.name : 'Anonymous Customer' %>
                  </h6>
                  <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>Verified Purchase
                  </small>
                </div>
              </div>
              <div class="review-rating d-flex align-items-center">
                <div class="stars me-2">
                  <% review.rating.times do %>
                    <i class="fas fa-star text-warning"></i>
                  <% end %>
                  <% (5 - review.rating).times do %>
                    <i class="far fa-star text-muted"></i>
                  <% end %>
                </div>
                <span class="rating-text fw-semibold text-primary">
                  <%= review.rating %>.0 out of 5
                </span>
              </div>
            </div>
            <div class="review-date text-end">
              <small class="text-muted d-block">
                <i class="fas fa-calendar me-1"></i>
                <%= review.created_at.strftime("%B %d, %Y") %>
              </small>
              <small class="text-muted">
                <%= time_ago_in_words(review.created_at) %> ago
              </small>
            </div>
          </div>
          
          <% if review.comment.present? %>
            <div class="review-comment bg-light p-3 rounded">
              <div class="comment-text">
                <%= simple_format(h(review.comment)) %>
              </div>
            </div>
          <% else %>
            <div class="no-comment text-muted fst-italic">
              <i class="fas fa-quote-left me-1"></i>
              No written review provided
            </div>
          <% end %>
          
          <!-- Review helpful section (optional) -->
          <div class="review-actions mt-3 d-flex justify-content-between align-items-center">
            <div class="review-helpfulness">
              <!-- You can add helpful/not helpful buttons here if needed -->
            </div>
            <div class="review-meta">
              <small class="text-muted">
                <i class="fas fa-thumbs-up me-1"></i>
                Review #<%= review.id %>
              </small>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="no-reviews text-center py-5 bg-light rounded">
        <div class="no-reviews-icon mb-3">
          <i class="fas fa-comment-slash text-muted" style="font-size: 3rem;"></i>
        </div>
        <h5 class="text-muted mb-2">No reviews yet</h5>
        <p class="text-muted mb-0">Be the first to share your experience with this product!</p>
        <% if user_signed_in? && current_user.buyer? %>
          <div class="mt-3">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Purchase this product to leave a review
            </small>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
function toggleReviewForm() {
  const formContainer = document.getElementById('review-form-container');
  if (formContainer.style.display === 'none' || formContainer.style.display === '') {
    formContainer.style.display = 'block';
    formContainer.scrollIntoView({ behavior: 'smooth' });
  } else {
    formContainer.style.display = 'none';
  }
}
</script>

<style>
.reviews-section {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid #dee2e6;
}

.overall-rating {
  text-align: right;
}

.rating-display .stars {
  font-size: 0.9rem;
}

.review-item:last-child {
  border-bottom: none !important;
}

.review-header {
  margin-bottom: 0.75rem;
}

.reviewer-info h6 {
  margin-bottom: 0.25rem;
  font-weight: 600;
}

.review-rating {
  font-size: 0.9rem;
}

.review-comment {
  margin-left: 0;
  padding-left: 0;
}

.review-comment p {
  line-height: 1.6;
  color: #495057;
}

.no-reviews {
  background-color: #f8f9fa;
  border-radius: 0.5rem;
  margin: 2rem 0;
}

.product-reviews-wrapper {
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 2px solid #e9ecef;
}

.product-tabs .nav-tabs {
  border: none;
  background: #f8f9fa;
  border-radius: 0.75rem;
  padding: 0.25rem;
}

.product-tabs .nav-link {
  border: none;
  color: #6c757d;
  background: transparent;
  border-radius: 0.5rem;
  font-weight: 500;
  padding: 0.75rem 1.5rem;
  transition: all 0.3s ease;
}

.product-tabs .nav-link:hover {
  background: rgba(13, 110, 253, 0.1);
  color: #0d6efd;
}

.product-tabs .nav-link.active {
  background: #0d6efd;
  color: white !important;
  box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.reviewer-avatar i {
  color: #0d6efd;
  background: rgba(13, 110, 253, 0.1);
  padding: 0.5rem;
  border-radius: 50%;
}

.review-item {
  transition: all 0.3s ease;
}

.review-item:hover {
  background: rgba(0, 0, 0, 0.02);
  transform: translateX(5px);
  padding-left: 1rem !important;
}

.review-comment {
  background: #f8f9fa;
  border-left: 4px solid #0d6efd;
}

.rating-text {
  font-size: 0.9rem;
}

.no-reviews {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #dee2e6;
}

@media (max-width: 768px) {
  .reviews-header {
    flex-direction: column;
    align-items: start !important;
    gap: 1rem;
  }
  
  .overall-rating {
    text-align: left;
  }
  
  .product-tabs .nav-link {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  
  .review-item:hover {
    transform: none;
    padding-left: 0.75rem !important;
  }
}
</style>